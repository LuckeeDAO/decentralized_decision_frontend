# 前端详细设计文档

## 📋 文档信息

**文档名称**: 前端详细设计文档  
**项目名称**: 基于比特承诺模型的去中心化投票系统  
**文档版本**: 1.0  
**创建时间**: 2025年8月  
**文档状态**: 详细设计完成  

## 🏗️ 项目结构设计

### 目录结构
```
src/
├── components/           # 通用组件
│   ├── common/          # 基础组件
│   │   ├── Button/
│   │   ├── Input/
│   │   ├── Card/
│   │   ├── Modal/
│   │   └── Table/
│   ├── layout/          # 布局组件
│   │   ├── Header/
│   │   ├── Sidebar/
│   │   ├── Footer/
│   │   └── PageLayout/
│   └── business/        # 业务组件
│       ├── voting/      # 投票相关
│       ├── nft/         # NFT相关
│       ├── token/       # 代币相关
│       └── admin/       # 管理相关
├── pages/               # 页面组件
│   ├── Dashboard/
│   ├── Voting/
│   ├── NFT/
│   ├── Token/
│   └── Admin/
├── hooks/               # 自定义Hooks
├── services/            # 服务层
├── store/               # 状态管理
├── utils/               # 工具函数
├── types/               # 类型定义
├── styles/              # 样式文件
└── assets/              # 静态资源
```

### 文件命名规范
- **组件文件**: PascalCase (如: `VotingList.tsx`)
- **工具文件**: camelCase (如: `apiClient.ts`)
- **类型文件**: camelCase (如: `votingTypes.ts`)
- **样式文件**: camelCase (如: `votingStyles.ts`)

## 🔧 核心组件详细设计

### 1. 用户认证模块

#### 1.1 WalletConnect 组件
```typescript
// src/components/common/WalletConnect/WalletConnect.tsx
import React, { useState, useEffect } from 'react';
import { useWallet } from '../../hooks/useWallet';
import { WalletButton, WalletStatus } from './components';

interface WalletConnectProps {
  onConnect?: (wallet: WalletInfo) => void;
  onDisconnect?: () => void;
  className?: string;
}

export const WalletConnect: React.FC<WalletConnectProps> = ({
  onConnect,
  onDisconnect,
  className
}) => {
  const { wallet, isConnected, connect, disconnect } = useWallet();
  const [isConnecting, setIsConnecting] = useState(false);

  const handleConnect = async () => {
    setIsConnecting(true);
    try {
      const walletInfo = await connect();
      onConnect?.(walletInfo);
    } catch (error) {
      console.error('Wallet connection failed:', error);
    } finally {
      setIsConnecting(false);
    }
  };

  const handleDisconnect = () => {
    disconnect();
    onDisconnect?.();
  };

  return (
    <div className={`wallet-connect ${className}`}>
      {!isConnected ? (
        <WalletButton
          onClick={handleConnect}
          disabled={isConnecting}
          loading={isConnecting}
        >
          {isConnecting ? '连接中...' : '连接钱包'}
        </WalletButton>
      ) : (
        <WalletStatus
          wallet={wallet}
          onDisconnect={handleDisconnect}
        />
      )}
    </div>
  );
};
```

#### 1.2 PermissionGuard 组件
```typescript
// src/components/common/PermissionGuard/PermissionGuard.tsx
import React from 'react';
import { usePermissions } from '../../hooks/usePermissions';

interface PermissionGuardProps {
  requiredPermission: string;
  fallback?: React.ReactNode;
  children: React.ReactNode;
}

export const PermissionGuard: React.FC<PermissionGuardProps> = ({
  requiredPermission,
  fallback,
  children
}) => {
  const { hasPermission, isLoading } = usePermissions();

  if (isLoading) {
    return <div>权限检查中...</div>;
  }

  if (!hasPermission(requiredPermission)) {
    return fallback || (
      <div className="permission-denied">
        <h3>权限不足</h3>
        <p>您没有执行此操作的权限</p>
        <p>所需权限: {requiredPermission}</p>
      </div>
    );
  }

  return <>{children}</>;
};
```

### 2. 投票管理模块

#### 2.1 VotingList 组件
```typescript
// src/components/business/voting/VotingList/VotingList.tsx
import React, { useState, useEffect } from 'react';
import { useVotingSessions } from '../../../hooks/useVotingSessions';
import { VotingCard, VotingFilters, Pagination } from './components';
import { VotingSession, VotingFilters as Filters } from '../../../types';

interface VotingListProps {
  onVotingSelect?: (voting: VotingSession) => void;
  showCreateButton?: boolean;
  className?: string;
}

export const VotingList: React.FC<VotingListProps> = ({
  onVotingSelect,
  showCreateButton = true,
  className
}) => {
  const [filters, setFilters] = useState<Filters>({
    status: 'all',
    type: 'all',
    search: ''
  });
  const [page, setPage] = useState(1);
  const [pageSize] = useState(10);

  const {
    sessions,
    isLoading,
    error,
    refetch
  } = useVotingSessions({ filters, page, pageSize });

  const handleVotingSelect = (voting: VotingSession) => {
    onVotingSelect?.(voting);
  };

  const handleFiltersChange = (newFilters: Partial<Filters>) => {
    setFilters(prev => ({ ...prev, ...newFilters }));
    setPage(1);
  };

  const handlePageChange = (newPage: number) => {
    setPage(newPage);
  };

  if (error) {
    return (
      <div className="error-container">
        <h3>加载失败</h3>
        <p>{error.message}</p>
        <button onClick={() => refetch()}>重试</button>
      </div>
    );
  }

  return (
    <div className={`voting-list ${className}`}>
      <div className="voting-list-header">
        <h2>投票列表</h2>
        {showCreateButton && (
          <button className="create-voting-btn">
            创建投票
          </button>
        )}
      </div>

      <VotingFilters
        filters={filters}
        onFiltersChange={handleFiltersChange}
      />

      <div className="voting-list-content">
        {isLoading ? (
          <div className="loading-container">
            <div className="loading-spinner" />
            <p>加载中...</p>
          </div>
        ) : sessions.length === 0 ? (
          <div className="empty-container">
            <p>暂无投票</p>
          </div>
        ) : (
          <div className="voting-grid">
            {sessions.map(session => (
              <VotingCard
                key={session.id}
                voting={session}
                onClick={() => handleVotingSelect(session)}
              />
            ))}
          </div>
        )}
      </div>

      {sessions.length > 0 && (
        <Pagination
          currentPage={page}
          totalPages={Math.ceil(sessions.length / pageSize)}
          onPageChange={handlePageChange}
        />
      )}
    </div>
  );
};
```

#### 2.2 VotingDetail 组件
```typescript
// src/components/business/voting/VotingDetail/VotingDetail.tsx
import React, { useState, useEffect } from 'react';
import { useVotingSession } from '../../../hooks/useVotingSession';
import { useVotingActions } from '../../../hooks/useVotingActions';
import {
  VotingInfo,
  VotingProgress,
  VotingActions,
  ParticipantsList,
  VotingResults
} from './components';
import { VotingSession } from '../../../types';

interface VotingDetailProps {
  votingId: string;
  onBack?: () => void;
  className?: string;
}

export const VotingDetail: React.FC<VotingDetailProps> = ({
  votingId,
  onBack,
  className
}) => {
  const [activeTab, setActiveTab] = useState<'info' | 'participants' | 'results'>('info');
  
  const {
    session,
    isLoading,
    error,
    refetch
  } = useVotingSession(votingId);

  const {
    submitCommitment,
    submitReveal,
    isSubmitting,
    submissionError
  } = useVotingActions(votingId);

  useEffect(() => {
    if (session) {
      // 根据投票状态自动切换标签
      if (session.state === 'Completed') {
        setActiveTab('results');
      }
    }
  }, [session]);

  const handleCommitmentSubmit = async (data: CommitmentData) => {
    try {
      await submitCommitment(data);
      refetch();
    } catch (error) {
      console.error('Commitment submission failed:', error);
    }
  };

  const handleRevealSubmit = async (data: RevealData) => {
    try {
      await submitReveal(data);
      refetch();
    } catch (error) {
      console.error('Reveal submission failed:', error);
    }
  };

  if (isLoading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner" />
        <p>加载投票详情中...</p>
      </div>
    );
  }

  if (error || !session) {
    return (
      <div className="error-container">
        <h3>加载失败</h3>
        <p>{error?.message || '投票不存在'}</p>
        <button onClick={() => refetch()}>重试</button>
        {onBack && (
          <button onClick={onBack}>返回列表</button>
        )}
      </div>
    );
  }

  return (
    <div className={`voting-detail ${className}`}>
      <div className="voting-detail-header">
        <button className="back-button" onClick={onBack}>
          ← 返回
        </button>
        <h1>{session.title}</h1>
        <VotingProgress session={session} />
      </div>

      <div className="voting-detail-tabs">
        <button
          className={`tab-button ${activeTab === 'info' ? 'active' : ''}`}
          onClick={() => setActiveTab('info')}
        >
          投票信息
        </button>
        <button
          className={`tab-button ${activeTab === 'participants' ? 'active' : ''}`}
          onClick={() => setActiveTab('participants')}
        >
          参与者
        </button>
        <button
          className={`tab-button ${activeTab === 'results' ? 'active' : ''}`}
          onClick={() => setActiveTab('results')}
        >
          结果
        </button>
      </div>

      <div className="voting-detail-content">
        {activeTab === 'info' && (
          <VotingInfo session={session} />
        )}
        
        {activeTab === 'participants' && (
          <ParticipantsList session={session} />
        )}
        
        {activeTab === 'results' && (
          <VotingResults session={session} />
        )}
      </div>

      <VotingActions
        session={session}
        onSubmitCommitment={handleCommitmentSubmit}
        onSubmitReveal={handleRevealSubmit}
        isSubmitting={isSubmitting}
        error={submissionError}
      />
    </div>
  );
};
```

### 3. NFT管理模块

#### 3.1 NFTGallery 组件
```typescript
// src/components/business/nft/NFTGallery/NFTGallery.tsx
import React, { useState, useEffect } from 'react';
import { useNFTs } from '../../../hooks/useNFTs';
import { NFTCard, NFTFilters, NFTGrid } from './components';
import { NFT, NFTFilters as Filters } from '../../../types';

interface NFTGalleryProps {
  onNFTSelect?: (nft: NFT) => void;
  showCreateButton?: boolean;
  className?: string;
}

export const NFTGallery: React.FC<NFTGalleryProps> = ({
  onNFTSelect,
  showCreateButton = false,
  className
}) => {
  const [filters, setFilters] = useState<Filters>({
    type: 'all',
    status: 'all',
    search: ''
  });
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');

  const {
    nfts,
    isLoading,
    error,
    refetch
  } = useNFTs({ filters });

  const handleNFTSelect = (nft: NFT) => {
    onNFTSelect?.(nft);
  };

  const handleFiltersChange = (newFilters: Partial<Filters>) => {
    setFilters(prev => ({ ...prev, ...newFilters }));
  };

  if (error) {
    return (
      <div className="error-container">
        <h3>加载失败</h3>
        <p>{error.message}</p>
        <button onClick={() => refetch()}>重试</button>
      </div>
    );
  }

  return (
    <div className={`nft-gallery ${className}`}>
      <div className="nft-gallery-header">
        <h2>我的NFT</h2>
        <div className="nft-gallery-controls">
          <NFTFilters
            filters={filters}
            onFiltersChange={handleFiltersChange}
          />
          <div className="view-mode-toggle">
            <button
              className={`toggle-btn ${viewMode === 'grid' ? 'active' : ''}`}
              onClick={() => setViewMode('grid')}
            >
              <GridIcon />
            </button>
            <button
              className={`toggle-btn ${viewMode === 'list' ? 'active' : ''}`}
              onClick={() => setViewMode('list')}
            >
              <ListIcon />
            </button>
          </div>
        </div>
      </div>

      <div className="nft-gallery-content">
        {isLoading ? (
          <div className="loading-container">
            <div className="loading-spinner" />
            <p>加载中...</p>
          </div>
        ) : nfts.length === 0 ? (
          <div className="empty-container">
            <p>暂无NFT</p>
          </div>
        ) : (
          <NFTGrid
            nfts={nfts}
            viewMode={viewMode}
            onNFTSelect={handleNFTSelect}
          />
        )}
      </div>
    </div>
  );
};
```

### 4. 治理代币管理模块

#### 4.1 GovernanceTokenBalance 组件
```typescript
// src/components/business/governance/GovernanceTokenBalance/GovernanceTokenBalance.tsx
import React from 'react';
import { useGovernanceToken } from '../../../hooks/useGovernanceToken';
import { TokenBalanceCard, PermissionLevelCard, GovernanceStats } from './components';

interface GovernanceTokenBalanceProps {
  className?: string;
}

export const GovernanceTokenBalance: React.FC<GovernanceTokenBalanceProps> = ({ className }) => {
  const {
    tokenBalance,
    permissionLevel,
    governanceStats,
    isLoading,
    error,
    refetch
  } = useGovernanceToken();

  if (isLoading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner" />
        <p>加载去中心化决策治理代币DDG信息中...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="error-container">
        <h3>加载失败</h3>
        <p>{error.message}</p>
        <button onClick={() => refetch()}>重试</button>
      </div>
    );
  }

  return (
    <div className={`governance-token-balance ${className}`}>
      <h2>去中心化决策治理代币DDG信息</h2>
      
      <div className="balance-overview">
        <TokenBalanceCard
          title="去中心化决策治理代币DDG余额"
          amount={tokenBalance.total}
          symbol="DDG"
          icon="governance"
        />
        
        <TokenBalanceCard
          title="可用余额"
          amount={tokenBalance.available}
          symbol="LUCKEE"
          icon="wallet"
        />
        
        <TokenBalanceCard
          title="质押余额"
          amount={tokenBalance.staked}
          symbol="LUCKEE"
          icon="lock"
        />
      </div>

      <div className="permission-info">
        <PermissionLevelCard
          level={permissionLevel.level}
          requirements={permissionLevel.requirements}
          nextLevel={permissionLevel.nextLevel}
        />
      </div>

      <div className="governance-stats">
        <GovernanceStats stats={governanceStats} />
      </div>
    </div>
  );
};
```

#### 4.2 PermissionLevelDisplay 组件
```typescript
// src/components/business/governance/PermissionLevelDisplay/PermissionLevelDisplay.tsx
import React from 'react';
import { usePermissionLevel } from '../../../hooks/usePermissionLevel';

interface PermissionLevelDisplayProps {
  className?: string;
}

export const PermissionLevelDisplay: React.FC<PermissionLevelDisplayProps> = ({ className }) => {
  const {
    currentLevel,
    nextLevel,
    requirements,
    isLoading
  } = usePermissionLevel();

  if (isLoading) {
    return <div>加载权限信息中...</div>;
  }

  return (
    <div className={`permission-level-display ${className}`}>
      <div className="current-level">
        <h3>当前权限等级</h3>
        <div className={`level-badge level-${currentLevel.toLowerCase()}`}>
          {currentLevel}
        </div>
        <p className="level-description">
          {getLevelDescription(currentLevel)}
        </p>
      </div>

      {nextLevel && (
        <div className="next-level">
          <h4>下一等级: {nextLevel.level}</h4>
          <p>需要持有: {nextLevel.requiredBalance} LUCKEE</p>
          <div className="progress-bar">
            <div 
              className="progress-fill"
              style={{ width: `${requirements.progress}%` }}
            />
          </div>
          <p>还需: {requirements.remaining} LUCKEE</p>
        </div>
      )}

      <div className="level-benefits">
        <h4>当前等级权益</h4>
        <ul>
          {getLevelBenefits(currentLevel).map((benefit, index) => (
            <li key={index}>{benefit}</li>
          ))}
        </ul>
      </div>
    </div>
  );
};

function getLevelDescription(level: string): string {
  switch (level) {
    case 'Basic': return '基础用户，可以参与投票和查看信息';
    case 'Creator': return '创建者，可以创建NFT类型和投票会话';
    case 'Admin': return '高级治理者，可以参与系统治理和参数调整';
    default: return '未知权限等级';
  }
}

function getLevelBenefits(level: string): string[] {
  switch (level) {
    case 'Basic': return ['参与投票', '查看结果', '持有NFT'];
    case 'Creator': return ['创建NFT类型', '创建投票会话', '管理投票'];
    case 'Admin': return ['参与治理', '参数调整', '紧急处理'];
    default: return [];
  }
}
```

## 🎨 样式设计规范

### 1. 设计系统

#### 1.1 颜色系统
```scss
// src/styles/variables/_colors.scss
:root {
  // 主色调
  --primary-color: #1976d2;
  --primary-light: #42a5f5;
  --primary-dark: #1565c0;
  
  // 辅助色
  --secondary-color: #dc004e;
  --secondary-light: #ff5983;
  --secondary-dark: #9a0036;
  
  // 成功色
  --success-color: #2e7d32;
  --success-light: #4caf50;
  --success-dark: #1b5e20;
  
  // 警告色
  --warning-color: #ed6c02;
  --warning-light: #ff9800;
  --warning-dark: #e65100;
  
  // 错误色
  --error-color: #d32f2f;
  --error-light: #f44336;
  --error-dark: #c62828;
  
  // 中性色
  --text-primary: rgba(0, 0, 0, 0.87);
  --text-secondary: rgba(0, 0, 0, 0.6);
  --text-disabled: rgba(0, 0, 0, 0.38);
  
  --background-default: #ffffff;
  --background-paper: #fafafa;
  --background-dark: #303030;
  
  --divider: rgba(0, 0, 0, 0.12);
  --border: rgba(0, 0, 0, 0.23);
}
```

#### 1.2 字体系统
```scss
// src/styles/variables/_typography.scss
:root {
  // 字体族
  --font-family-primary: 'Roboto', 'Helvetica', 'Arial', sans-serif;
  --font-family-mono: 'Roboto Mono', 'Consolas', 'Monaco', monospace;
  
  // 字体大小
  --font-size-xs: 0.75rem;    // 12px
  --font-size-sm: 0.875rem;   // 14px
  --font-size-md: 1rem;       // 16px
  --font-size-lg: 1.125rem;   // 18px
  --font-size-xl: 1.25rem;    // 20px
  --font-size-xxl: 1.5rem;    // 24px
  
  // 字体权重
  --font-weight-light: 300;
  --font-weight-regular: 400;
  --font-weight-medium: 500;
  --font-weight-bold: 700;
  
  // 行高
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --line-height-relaxed: 1.8;
}
```

#### 1.3 间距系统
```scss
// src/styles/variables/_spacing.scss
:root {
  // 基础间距单位
  --spacing-unit: 8px;
  
  // 间距值
  --spacing-xs: calc(var(--spacing-unit) * 0.5);   // 4px
  --spacing-sm: var(--spacing-unit);                // 8px
  --spacing-md: calc(var(--spacing-unit) * 1.5);   // 12px
  --spacing-lg: calc(var(--spacing-unit) * 2);     // 16px
  --spacing-xl: calc(var(--spacing-unit) * 3);     // 24px
  --spacing-xxl: calc(var(--spacing-unit) * 4);    // 32px
  
  // 组件间距
  --component-padding: var(--spacing-md);
  --component-margin: var(--spacing-md);
  --section-spacing: var(--spacing-xl);
  --page-spacing: var(--spacing-xxl);
}
```

### 2. 组件样式

#### 2.1 Button 组件样式
```scss
// src/components/common/Button/Button.scss
.button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-sm) var(--spacing-md);
  border: none;
  border-radius: 4px;
  font-family: var(--font-family-primary);
  font-size: var(--font-size-md);
  font-weight: var(--font-weight-medium);
  line-height: var(--line-height-normal);
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  
  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  // 变体样式
  &--primary {
    background-color: var(--primary-color);
    color: white;
    
    &:hover:not(:disabled) {
      background-color: var(--primary-dark);
    }
  }
  
  &--secondary {
    background-color: transparent;
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
    
    &:hover:not(:disabled) {
      background-color: var(--primary-color);
      color: white;
    }
  }
  
  &--outlined {
    background-color: transparent;
    color: var(--text-primary);
    border: 1px solid var(--border);
    
    &:hover:not(:disabled) {
      background-color: var(--background-paper);
      border-color: var(--primary-color);
    }
  }
  
  // 尺寸样式
  &--small {
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-sm);
  }
  
  &--large {
    padding: var(--spacing-md) var(--spacing-lg);
    font-size: var(--font-size-lg);
  }
}
```

## 🔄 状态管理设计

### 1. Redux Store 结构

#### 1.1 Store 配置
```typescript
// src/store/index.ts
import { configureStore } from '@reduxjs/toolkit';
import { setupListeners } from '@reduxjs/toolkit/query';
import { api } from './api';
import authReducer from './slices/authSlice';
import votingReducer from './slices/votingSlice';
import nftReducer from './slices/nftSlice';
import tokenReducer from './slices/tokenSlice';
import uiReducer from './slices/uiSlice';

export const store = configureStore({
  reducer: {
    [api.reducerPath]: api.reducer,
    auth: authReducer,
    voting: votingReducer,
    nft: nftReducer,
    token: tokenReducer,
    ui: uiReducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(api.middleware),
  devTools: process.env.NODE_ENV !== 'production',
});

setupListeners(store.dispatch);

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

#### 1.2 Auth Slice
```typescript
// src/store/slices/authSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { WalletInfo, UserPermissions, PermissionLevel } from '../../types';

interface AuthState {
  wallet: WalletInfo | null;
  permissions: UserPermissions | null;
  governanceTokenBalance: number;
  permissionLevel: PermissionLevel;
  isConnected: boolean;
  isLoading: boolean;
  error: string | null;
}

const initialState: AuthState = {
  wallet: null,
  permissions: null,
  governanceTokenBalance: 0,
  permissionLevel: PermissionLevel.Basic,
  isConnected: false,
  isLoading: false,
  error: null,
};

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    setWallet: (state, action: PayloadAction<WalletInfo>) => {
      state.wallet = action.payload;
      state.isConnected = true;
      state.error = null;
    },
    setPermissions: (state, action: PayloadAction<UserPermissions>) => {
      state.permissions = action.payload;
    },
    setGovernanceTokenBalance: (state, action: PayloadAction<number>) => {
      state.governanceTokenBalance = action.payload;
      // 自动计算权限等级
      state.permissionLevel = calculatePermissionLevel(action.payload);
    },
    setPermissionLevel: (state, action: PayloadAction<PermissionLevel>) => {
      state.permissionLevel = action.payload;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.isLoading = action.payload;
    },
    setError: (state, action: PayloadAction<string>) => {
      state.error = action.payload;
    },
    disconnect: (state) => {
      state.wallet = null;
      state.permissions = null;
      state.governanceTokenBalance = 0;
      state.permissionLevel = PermissionLevel.Basic;
      state.isConnected = false;
      state.error = null;
    },
  },
});

// 基于代币余额自动计算权限等级
function calculatePermissionLevel(balance: number): PermissionLevel {
  if (balance >= 100000) {
    return PermissionLevel.Admin;
  } else if (balance >= 1000) {
    return PermissionLevel.Creator;
  } else {
    return PermissionLevel.Basic;
  }
}

export const {
  setWallet,
  setPermissions,
  setGovernanceTokenBalance,
  setPermissionLevel,
  setLoading,
  setError,
  disconnect,
} = authSlice.actions;

export default authSlice.reducer;
```

### 2. RTK Query API

#### 2.1 API 配置
```typescript
// src/store/api/index.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';
import { RootState } from '../index';

export const api = createApi({
  reducerPath: 'api',
  baseQuery: fetchBaseQuery({
    baseUrl: process.env.REACT_APP_API_BASE_URL || 'http://localhost:8080',
    prepareHeaders: (headers, { getState }) => {
      const state = getState() as RootState;
      if (state.auth.wallet?.address) {
        headers.set('x-address', state.auth.wallet.address);
      }
      return headers;
    },
  }),
  tagTypes: ['Voting', 'NFT', 'Token', 'User'],
  endpoints: () => ({}),
});
```

#### 2.2 投票 API
```typescript
// src/store/api/votingApi.ts
import { api } from './index';
import { VotingSession, CreateVotingRequest, VotingFilters } from '../../types';

export const votingApi = api.injectEndpoints({
  endpoints: (builder) => ({
    getVotingSessions: builder.query<VotingSession[], VotingFilters>({
      query: (filters) => ({
        url: '/sessions',
        params: filters,
      }),
      providesTags: ['Voting'],
    }),
    
    getVotingSession: builder.query<VotingSession, string>({
      query: (id) => `/sessions/${id}`,
      providesTags: (result, error, id) => [{ type: 'Voting', id }],
    }),
    
    createVotingSession: builder.mutation<VotingSession, CreateVotingRequest>({
      query: (body) => ({
        url: '/sessions',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['Voting'],
    }),
    
    submitCommitment: builder.mutation<void, { sessionId: string; data: any }>({
      query: ({ sessionId, data }) => ({
        url: `/sessions/${sessionId}/commitments`,
        method: 'POST',
        body: data,
      }),
      invalidatesTags: (result, error, { sessionId }) => [
        { type: 'Voting', id: sessionId }
      ],
    }),
    
    submitReveal: builder.mutation<void, { sessionId: string; data: any }>({
      query: ({ sessionId, data }) => ({
        url: `/sessions/${sessionId}/reveals`,
        method: 'POST',
        body: data,
      }),
      invalidatesTags: (result, error, { sessionId }) => [
        { type: 'Voting', id: sessionId }
      ],
    }),
  }),
});

export const {
  useGetVotingSessionsQuery,
  useGetVotingSessionQuery,
  useCreateVotingSessionMutation,
  useSubmitCommitmentMutation,
  useSubmitRevealMutation,
} = votingApi;
```

## 🧪 测试设计

### 1. 组件测试

#### 1.1 VotingList 测试
```typescript
// src/components/business/voting/VotingList/__tests__/VotingList.test.tsx
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { Provider } from 'react-redux';
import { configureStore } from '@reduxjs/toolkit';
import { VotingList } from '../VotingList';
import { votingApi } from '../../../../store/api/votingApi';

const mockStore = configureStore({
  reducer: {
    [votingApi.reducerPath]: votingApi.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(votingApi.middleware),
});

const mockVotingSessions = [
  {
    id: '1',
    title: '测试投票1',
    description: '这是一个测试投票',
    state: 'Active',
    participants: ['user1', 'user2'],
    created_at: Date.now(),
  },
  {
    id: '2',
    title: '测试投票2',
    description: '这是另一个测试投票',
    state: 'Completed',
    participants: ['user3', 'user4'],
    created_at: Date.now(),
  },
];

describe('VotingList', () => {
  beforeEach(() => {
    // Mock API response
    jest.spyOn(global, 'fetch').mockResolvedValue({
      ok: true,
      json: async () => mockVotingSessions,
    } as Response);
  });

  afterEach(() => {
    jest.restoreAllMocks();
  });

  it('renders voting list correctly', async () => {
    render(
      <Provider store={mockStore}>
        <VotingList />
      </Provider>
    );

    await waitFor(() => {
      expect(screen.getByText('投票列表')).toBeInTheDocument();
      expect(screen.getByText('测试投票1')).toBeInTheDocument();
      expect(screen.getByText('测试投票2')).toBeInTheDocument();
    });
  });

  it('handles voting selection', async () => {
    const mockOnSelect = jest.fn();
    
    render(
      <Provider store={mockStore}>
        <VotingList onVotingSelect={mockOnSelect} />
      </Provider>
    );

    await waitFor(() => {
      const votingCard = screen.getByText('测试投票1');
      fireEvent.click(votingCard);
      expect(mockOnSelect).toHaveBeenCalledWith(mockVotingSessions[0]);
    });
  });

  it('shows loading state', () => {
    render(
      <Provider store={mockStore}>
        <VotingList />
      </Provider>
    );

    expect(screen.getByText('加载中...')).toBeInTheDocument();
  });

  it('shows error state when API fails', async () => {
    jest.spyOn(global, 'fetch').mockRejectedValue(new Error('API Error'));

    render(
      <Provider store={mockStore}>
        <VotingList />
      </Provider>
    );

    await waitFor(() => {
      expect(screen.getByText('加载失败')).toBeInTheDocument();
      expect(screen.getByText('API Error')).toBeInTheDocument();
    });
  });
});
```

### 2. Hook 测试

#### 2.1 useVotingSessions 测试
```typescript
// src/hooks/__tests__/useVotingSessions.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { Provider } from 'react-redux';
import { configureStore } from '@reduxjs/toolkit';
import { useVotingSessions } from '../useVotingSessions';
import { votingApi } from '../../store/api/votingApi';

const mockStore = configureStore({
  reducer: {
    [votingApi.reducerPath]: votingApi.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(votingApi.middleware),
});

describe('useVotingSessions', () => {
  it('fetches voting sessions successfully', async () => {
    const mockSessions = [
      { id: '1', title: 'Test Voting' },
      { id: '2', title: 'Another Voting' },
    ];

    jest.spyOn(global, 'fetch').mockResolvedValue({
      ok: true,
      json: async () => mockSessions,
    } as Response);

    const { result } = renderHook(
      () => useVotingSessions({ status: 'all' }),
      {
        wrapper: ({ children }) => (
          <Provider store={mockStore}>{children}</Provider>
        ),
      }
    );

    await waitFor(() => {
      expect(result.current.sessions).toEqual(mockSessions);
      expect(result.current.isLoading).toBe(false);
      expect(result.current.error).toBe(null);
    });
  });

  it('handles API errors correctly', async () => {
    jest.spyOn(global, 'fetch').mockRejectedValue(new Error('Network Error'));

    const { result } = renderHook(
      () => useVotingSessions({ status: 'all' }),
      {
        wrapper: ({ children }) => (
          <Provider store={mockStore}>{children}</Provider>
        ),
      }
    );

    await waitFor(() => {
      expect(result.current.error).toBeTruthy();
      expect(result.current.isLoading).toBe(false);
    });
  });
});
```

## 📱 移动端预留接口

### 1. 响应式组件

#### 1.1 触摸事件处理
```typescript
// src/hooks/useTouchEvents.ts
import { useState, useCallback } from 'react';

interface TouchPoint {
  x: number;
  y: number;
}

interface TouchEvents {
  onTouchStart: (e: React.TouchEvent) => void;
  onTouchMove: (e: React.TouchEvent) => void;
  onTouchEnd: (e: React.TouchEvent) => void;
  onSwipe: (direction: 'left' | 'right' | 'up' | 'down') => void;
}

export const useTouchEvents = (swipeThreshold = 50): TouchEvents => {
  const [touchStart, setTouchStart] = useState<TouchPoint | null>(null);
  const [touchEnd, setTouchEnd] = useState<TouchPoint | null>(null);

  const onTouchStart = useCallback((e: React.TouchEvent) => {
    setTouchEnd(null);
    setTouchStart({
      x: e.targetTouches[0].clientX,
      y: e.targetTouches[0].clientY,
    });
  }, []);

  const onTouchMove = useCallback((e: React.TouchEvent) => {
    setTouchEnd({
      x: e.targetTouches[0].clientX,
      y: e.targetTouches[0].clientY,
    });
  }, []);

  const onTouchEnd = useCallback(() => {
    if (!touchStart || !touchEnd) return;

    const distanceX = touchStart.x - touchEnd.x;
    const distanceY = touchStart.y - touchEnd.y;
    const isHorizontalSwipe = Math.abs(distanceX) > Math.abs(distanceY);

    if (isHorizontalSwipe) {
      if (Math.abs(distanceX) > swipeThreshold) {
        if (distanceX > 0) {
          // Swipe left
        } else {
          // Swipe right
        }
      }
    } else {
      if (Math.abs(distanceY) > swipeThreshold) {
        if (distanceY > 0) {
          // Swipe up
        } else {
          // Swipe down
        }
      }
    }
  }, [touchStart, touchEnd, swipeThreshold]);

  return {
    onTouchStart,
    onTouchMove,
    onTouchEnd,
    onSwipe: () => {}, // Placeholder for swipe callback
  };
};
```

#### 1.2 移动端导航组件
```typescript
// src/components/layout/MobileNavigation/MobileNavigation.tsx
import React, { useState } from 'react';
import { useTouchEvents } from '../../../hooks/useTouchEvents';
import { MobileNavItem, MobileNavOverlay } from './components';

interface MobileNavigationProps {
  items: Array<{
    id: string;
    label: string;
    icon: React.ReactNode;
    path: string;
  }>;
  onNavigate: (path: string) => void;
  className?: string;
}

export const MobileNavigation: React.FC<MobileNavigationProps> = ({
  items,
  onNavigate,
  className
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const { onTouchStart, onTouchMove, onTouchEnd } = useTouchEvents();

  const handleItemClick = (path: string) => {
    onNavigate(path);
    setIsOpen(false);
  };

  const toggleMenu = () => {
    setIsOpen(!isOpen);
  };

  return (
    <div className={`mobile-navigation ${className}`}>
      <button
        className="mobile-nav-toggle"
        onClick={toggleMenu}
        aria-label="Toggle navigation menu"
      >
        <span className={`hamburger ${isOpen ? 'open' : ''}`} />
      </button>

      <MobileNavOverlay
        isOpen={isOpen}
        onClose={() => setIsOpen(false)}
        onTouchStart={onTouchStart}
        onTouchMove={onTouchMove}
        onTouchEnd={onTouchEnd}
      >
        <nav className="mobile-nav-menu">
          {items.map(item => (
            <MobileNavItem
              key={item.id}
              item={item}
              onClick={() => handleItemClick(item.path)}
            />
          ))}
        </nav>
      </MobileNavOverlay>
    </div>
  );
};
```

---

**文档编制日期**：2025年8月  
**文档编制人**：luckeeDAO技术评估团队  
**文档审核人**：luckeeDAO管理委员会  

**最后更新**：2025-08  
**维护人**：文档与架构联合组
