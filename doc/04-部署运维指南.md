# Luckee DAO 前端部署运维指南

## 概述

本文档详细介绍了 Luckee DAO 前端应用的部署流程、运维管理、监控策略和故障排除方法。

## 部署架构

### 1. 部署环境

#### 生产环境
- **平台**: GitHub Pages
- **域名**: https://luckeedao.github.io/decentralized_decision_frontend/
- **CDN**: GitHub Pages 内置 CDN
- **SSL**: 自动 HTTPS 证书

#### 开发环境
- **本地开发**: Vite 开发服务器
- **端口**: 3000 (默认)
- **热重载**: 支持
- **调试工具**: React DevTools, Redux DevTools

### 2. 部署流程

#### 自动化部署
```bash
# 部署到 GitHub Pages
npm run deploy:pages
```

#### 手动部署
```bash
# 1. 构建项目
npm run build

# 2. 创建 SPA 404 重定向
cat > dist/404.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Redirecting...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
    (function() {
      var path = window.location.pathname;
      var base = '/decentralized_decision_frontend/';
      var hash = window.location.hash || '#/';
      
      if (!path.startsWith(base)) {
        window.location.replace(base + '#/');
        return;
      }
      
      var sub = path.slice(base.length);
      if (!hash || hash === '#/' || hash === '#') {
        if (sub && sub !== '' && sub !== 'index.html') {
          if (sub.endsWith('/')) sub = sub.slice(0, -1);
          window.location.replace(base + '#/' + sub);
          return;
        }
      }
      window.location.replace(base + '#/');
    })();
  </script>
</head>
<body>Redirecting...</body>
</html>
EOF

# 3. 推送到 gh-pages 分支
git subtree push --prefix dist origin gh-pages
```

## 构建配置

### 1. Vite 配置
```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  base: '/decentralized_decision_frontend/',
  build: {
    outDir: 'dist',
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          mui: ['@mui/material', '@mui/icons-material'],
          charts: ['recharts'],
          router: ['react-router-dom'],
          state: ['@reduxjs/toolkit', '@tanstack/react-query'],
        },
      },
    },
  },
  server: {
    port: 3000,
    open: true,
    cors: true,
  },
  preview: {
    port: 4173,
    open: true,
  },
});
```

### 2. 环境变量配置
```bash
# .env.production
VITE_API_BASE_URL=https://api.luckeedao.com/api/v2
VITE_APP_NAME=Luckee DAO
VITE_APP_VERSION=1.0.0
VITE_APP_ENV=production

# .env.development
VITE_API_BASE_URL=http://localhost:8080/api/v2
VITE_APP_NAME=Luckee DAO (Dev)
VITE_APP_VERSION=1.0.0-dev
VITE_APP_ENV=development
```

### 3. TypeScript 配置
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

## 性能优化

### 1. 代码分割
```typescript
// 路由级别的代码分割
import { lazy, Suspense } from 'react';

const VotingPage = lazy(() => import('./pages/VotingPage'));
const GovernancePage = lazy(() => import('./pages/GovernancePage'));
const NFTPage = lazy(() => import('./pages/NFTPage'));
const SettingsPage = lazy(() => import('./pages/SettingsPage'));

// 使用 Suspense 包装
<Suspense fallback={<LoadingSpinner />}>
  <Routes>
    <Route path="/voting" element={<VotingPage />} />
    <Route path="/governance" element={<GovernancePage />} />
    <Route path="/nft" element={<NFTPage />} />
    <Route path="/settings" element={<SettingsPage />} />
  </Routes>
</Suspense>
```

### 2. 资源优化
```typescript
// 图片懒加载
const LazyImage = ({ src, alt, ...props }) => {
  const [isLoaded, setIsLoaded] = useState(false);
  const [isInView, setIsInView] = useState(false);
  const imgRef = useRef<HTMLImageElement>(null);

  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsInView(true);
          observer.disconnect();
        }
      },
      { threshold: 0.1 }
    );

    if (imgRef.current) {
      observer.observe(imgRef.current);
    }

    return () => observer.disconnect();
  }, []);

  return (
    <div ref={imgRef} {...props}>
      {isInView && (
        <img
          src={src}
          alt={alt}
          onLoad={() => setIsLoaded(true)}
          style={{ opacity: isLoaded ? 1 : 0 }}
        />
      )}
    </div>
  );
};
```

### 3. 缓存策略
```typescript
// Service Worker 缓存策略
const CACHE_NAME = 'luckee-dao-v1';
const CACHE_URLS = [
  '/',
  '/static/js/bundle.js',
  '/static/css/main.css',
  '/manifest.json'
];

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => cache.addAll(CACHE_URLS))
  );
});

self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then((response) => {
        if (response) {
          return response;
        }
        return fetch(event.request);
      })
  );
});
```

## 监控和日志

### 1. 性能监控
```typescript
// Web Vitals 监控
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

const sendToAnalytics = (metric: any) => {
  // 发送到分析服务
  if (window.gtag) {
    window.gtag('event', metric.name, {
      event_category: 'Web Vitals',
      event_label: metric.id,
      value: Math.round(metric.value),
      non_interaction: true,
    });
  }
};

getCLS(sendToAnalytics);
getFID(sendToAnalytics);
getFCP(sendToAnalytics);
getLCP(sendToAnalytics);
getTTFB(sendToAnalytics);
```

### 2. 错误监控
```typescript
// 全局错误处理
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  
  // 发送到错误监控服务
  if (window.gtag) {
    window.gtag('event', 'exception', {
      description: event.error?.message || 'Unknown error',
      fatal: false,
    });
  }
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  
  // 发送到错误监控服务
  if (window.gtag) {
    window.gtag('event', 'exception', {
      description: event.reason?.message || 'Unhandled promise rejection',
      fatal: false,
    });
  }
});
```

### 3. 用户行为分析
```typescript
// 用户行为追踪
const trackUserAction = (action: string, category: string, label?: string) => {
  if (window.gtag) {
    window.gtag('event', action, {
      event_category: category,
      event_label: label,
    });
  }
};

// 使用示例
const handleVote = (proposalId: string, option: string) => {
  trackUserAction('vote', 'governance', `${proposalId}-${option}`);
  // 执行投票逻辑
};
```

## 安全配置

### 1. 内容安全策略
```html
<!-- index.html -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  font-src 'self' data:;
  connect-src 'self' https://api.luckeedao.com;
  frame-ancestors 'none';
">
```

### 2. HTTPS 配置
```typescript
// 强制 HTTPS
if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
  location.replace('https:' + window.location.href.substring(window.location.protocol.length));
}
```

### 3. 输入验证
```typescript
// 输入验证工具
export const validateInput = {
  email: (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
  address: (address: string) => /^0x[a-fA-F0-9]{40}$/.test(address),
  amount: (amount: string) => /^\d+(\.\d+)?$/.test(amount) && parseFloat(amount) > 0,
  proposalId: (id: string) => /^[a-zA-Z0-9-_]+$/.test(id),
};
```

## 故障排除

### 1. 常见问题

#### 问题 1: 页面显示空白
**原因**: JavaScript 错误或路由配置问题
**解决方案**:
```bash
# 检查控制台错误
# 验证路由配置
# 检查构建产物
ls -la dist/
```

#### 问题 2: API 请求失败
**原因**: 网络问题或 API 服务不可用
**解决方案**:
```typescript
// 检查网络状态
const checkNetworkStatus = async () => {
  try {
    const response = await fetch('/api/health');
    return response.ok;
  } catch (error) {
    console.error('Network check failed:', error);
    return false;
  }
};
```

#### 问题 3: 构建失败
**原因**: 依赖问题或配置错误
**解决方案**:
```bash
# 清理缓存
rm -rf node_modules package-lock.json
npm install

# 检查 TypeScript 错误
npm run type-check

# 检查 ESLint 错误
npm run lint
```

### 2. 调试工具

#### 开发工具
```typescript
// Redux DevTools 配置
const store = configureStore({
  reducer: rootReducer,
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: [FLUSH, REHYDRATE, PAUSE, PERSIST, PURGE, REGISTER],
      },
    }),
  devTools: process.env.NODE_ENV !== 'production',
});
```

#### 生产调试
```typescript
// 生产环境调试开关
const DEBUG_MODE = process.env.VITE_DEBUG === 'true';

if (DEBUG_MODE) {
  console.log('Debug mode enabled');
  window.__DEBUG__ = {
    store: store.getState(),
    api: apiClient,
    auth: AuthManager,
  };
}
```

## 备份和恢复

### 1. 代码备份
```bash
# 创建备份分支
git checkout -b backup-$(date +%Y%m%d)
git push origin backup-$(date +%Y%m%d)

# 创建标签
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0
```

### 2. 数据备份
```typescript
// 本地存储备份
const backupLocalStorage = () => {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key) {
      data[key] = localStorage.getItem(key);
    }
  }
  return JSON.stringify(data);
};

const restoreLocalStorage = (backupData: string) => {
  const data = JSON.parse(backupData);
  Object.entries(data).forEach(([key, value]) => {
    localStorage.setItem(key, value as string);
  });
};
```

## 更新和维护

### 1. 版本管理
```json
{
  "version": "1.0.0",
  "scripts": {
    "version:patch": "npm version patch",
    "version:minor": "npm version minor",
    "version:major": "npm version major"
  }
}
```

### 2. 依赖更新
```bash
# 检查过时的依赖
npm outdated

# 更新依赖
npm update

# 更新特定依赖
npm install package@latest
```

### 3. 安全更新
```bash
# 检查安全漏洞
npm audit

# 修复安全漏洞
npm audit fix

# 强制修复
npm audit fix --force
```

## 扩展和升级

### 1. 功能扩展
- 添加新的页面和组件
- 集成新的 API 接口
- 实现新的用户交互功能
- 添加多语言支持

### 2. 性能优化
- 实现更细粒度的代码分割
- 添加预加载和预取策略
- 优化图片和资源加载
- 实现离线功能

### 3. 技术升级
- 升级 React 到最新版本
- 升级 TypeScript 到最新版本
- 升级构建工具和依赖
- 实现新的 Web 标准

---

*文档版本: 1.0.0*  
*最后更新: 2024年12月*  
*维护者: Luckee DAO 开发团队*
