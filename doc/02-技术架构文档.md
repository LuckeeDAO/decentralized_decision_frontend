# Luckee DAO 前端技术架构文档

## 概述

本文档详细介绍了 Luckee DAO 前端应用的技术架构、设计模式、技术选型和实现细节。

## 技术栈

### 核心框架
- **React 18.2.0**: 用户界面库，支持并发特性和 Suspense
- **TypeScript 4.9.3**: 类型安全的 JavaScript 超集
- **Vite 4.1.0**: 快速的构建工具和开发服务器

### UI 框架
- **Material-UI 5.11.10**: Google Material Design 组件库
- **Emotion**: CSS-in-JS 样式解决方案
- **Framer Motion 10.0.1**: 动画和手势库

### 状态管理
- **Redux Toolkit 1.9.3**: 可预测的状态管理
- **React Query 5.87.1**: 服务器状态管理和缓存
- **React Hook Form 7.43.5**: 表单状态管理

### 路由和导航
- **React Router DOM 6.8.1**: 客户端路由管理
- **HashRouter**: GitHub Pages 兼容的路由模式

### 数据可视化
- **Recharts 2.5.0**: 基于 React 的图表库
- **自定义图表组件**: 投票结果和治理数据可视化

### 工具库
- **Axios 1.3.4**: HTTP 客户端
- **Lodash 4.17.21**: 实用工具库
- **Date-fns 2.29.3**: 日期处理库
- **React Hot Toast 2.4.0**: 通知组件

## 项目结构

```
src/
├── components/          # 可复用组件
│   ├── common/         # 通用组件
│   ├── forms/          # 表单组件
│   ├── charts/         # 图表组件
│   └── layout/         # 布局组件
├── pages/              # 页面组件
│   ├── VotingPage.tsx  # 投票页面
│   ├── GovernancePage.tsx # 治理页面
│   ├── NFTPage.tsx     # NFT页面
│   └── SettingsPage.tsx # 设置页面
├── hooks/              # 自定义 Hooks
│   ├── useAuth.ts      # 认证相关
│   ├── useApi.ts       # API 调用
│   └── useLocalStorage.ts # 本地存储
├── store/              # 状态管理
│   ├── index.ts        # Store 配置
│   ├── slices/         # Redux Slices
│   └── api/            # API 状态管理
├── utils/              # 工具函数
│   ├── api.ts          # API 客户端
│   ├── constants.ts    # 常量定义
│   ├── formatters.ts   # 数据格式化
│   └── validators.ts   # 验证函数
├── types/              # TypeScript 类型定义
│   ├── api.ts          # API 类型
│   ├── auth.ts         # 认证类型
│   └── common.ts       # 通用类型
├── styles/             # 样式文件
│   ├── theme.ts        # Material-UI 主题
│   ├── globals.css     # 全局样式
│   └── components/     # 组件样式
├── App.tsx             # 主应用组件
└── main.tsx            # 应用入口
```

## 架构设计模式

### 1. 组件化架构

#### 组件分层
```
页面组件 (Pages)
    ↓
业务组件 (Business Components)
    ↓
通用组件 (Common Components)
    ↓
基础组件 (Base Components)
```

#### 组件设计原则
- **单一职责**: 每个组件只负责一个功能
- **可复用性**: 组件设计考虑复用场景
- **可测试性**: 组件易于单元测试
- **可维护性**: 清晰的组件接口和文档

### 2. 状态管理架构

#### 状态分层
```
UI 状态 (UI State)
    ↓
业务状态 (Business State)
    ↓
服务器状态 (Server State)
    ↓
持久化状态 (Persistent State)
```

#### 状态管理策略
- **Redux Toolkit**: 全局业务状态
- **React Query**: 服务器状态和缓存
- **useState/useReducer**: 组件本地状态
- **Context API**: 跨组件状态共享

### 3. 数据流架构

#### 单向数据流
```
用户交互 → Action → Reducer → Store → Component → UI
    ↓
API 调用 → React Query → Cache → Component → UI
```

#### 数据获取策略
- **缓存优先**: 优先使用缓存数据
- **后台更新**: 静默更新过期数据
- **乐观更新**: 立即更新 UI，后台同步
- **错误重试**: 自动重试失败的请求

## 技术实现细节

### 1. 路由管理

#### 路由配置
```typescript
// 使用 HashRouter 支持 GitHub Pages
<HashRouter>
  <Routes>
    <Route path="/" element={<HomePage />} />
    <Route path="/voting" element={<VotingPage />} />
    <Route path="/governance" element={<GovernancePage />} />
    <Route path="/nft" element={<NFTPage />} />
    <Route path="/settings" element={<SettingsPage />} />
    <Route path="*" element={<Navigate to="/" replace />} />
  </Routes>
</HashRouter>
```

#### 路由守卫
```typescript
// 认证路由守卫
const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const { isAuthenticated } = useAuth();
  return isAuthenticated ? children : <Navigate to="/login" />;
};
```

### 2. 状态管理

#### Redux Store 配置
```typescript
export const store = configureStore({
  reducer: {
    auth: authSlice.reducer,
    voting: votingSlice.reducer,
    governance: governanceSlice.reducer,
    ui: uiSlice.reducer,
    api: apiSlice.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: [FLUSH, REHYDRATE, PAUSE, PERSIST, PURGE, REGISTER],
      },
    }).concat(apiSlice.middleware),
});
```

#### React Query 配置
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5分钟
      cacheTime: 10 * 60 * 1000, // 10分钟
      retry: 3,
      retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
    },
  },
});
```

### 3. API 集成

#### API 客户端配置
```typescript
const apiClient = axios.create({
  baseURL: process.env.REACT_APP_API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
apiClient.interceptors.request.use(
  (config) => {
    const token = getAuthToken();
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);
```

#### API 状态管理
```typescript
export const apiSlice = createApi({
  reducerPath: 'api',
  baseQuery: fetchBaseQuery({
    baseUrl: '/api/v2',
    prepareHeaders: (headers, { getState }) => {
      const token = selectAuthToken(getState());
      if (token) {
        headers.set('authorization', `Bearer ${token}`);
      }
      return headers;
    },
  }),
  tagTypes: ['Voting', 'Governance', 'NFT'],
  endpoints: (builder) => ({
    getVotingProposals: builder.query({
      query: () => 'voting/proposals',
      providesTags: ['Voting'],
    }),
    // ... 其他 endpoints
  }),
});
```

### 4. 样式管理

#### Material-UI 主题配置
```typescript
const theme = createTheme({
  palette: {
    mode: 'light',
    primary: {
      main: '#1976d2',
    },
    secondary: {
      main: '#dc004e',
    },
  },
  typography: {
    fontFamily: '"Roboto", "Helvetica", "Arial", sans-serif',
  },
  components: {
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
        },
      },
    },
  },
});
```

#### 响应式设计
```typescript
const useResponsive = () => {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));
  const isTablet = useMediaQuery(theme.breakpoints.between('md', 'lg'));
  const isDesktop = useMediaQuery(theme.breakpoints.up('lg'));
  
  return { isMobile, isTablet, isDesktop };
};
```

## 性能优化

### 1. 代码分割
```typescript
// 路由级别的代码分割
const VotingPage = lazy(() => import('./pages/VotingPage'));
const GovernancePage = lazy(() => import('./pages/GovernancePage'));

// 组件级别的代码分割
const HeavyChart = lazy(() => import('./components/HeavyChart'));
```

### 2. 缓存策略
```typescript
// React Query 缓存配置
const useVotingData = () => {
  return useQuery({
    queryKey: ['voting', 'proposals'],
    queryFn: fetchVotingProposals,
    staleTime: 5 * 60 * 1000, // 5分钟内数据新鲜
    cacheTime: 30 * 60 * 1000, // 30分钟缓存
  });
};
```

### 3. 虚拟化
```typescript
// 大列表虚拟化
import { FixedSizeList as List } from 'react-window';

const VirtualizedList = ({ items }) => (
  <List
    height={600}
    itemCount={items.length}
    itemSize={80}
    itemData={items}
  >
    {({ index, style, data }) => (
      <div style={style}>
        <ListItem item={data[index]} />
      </div>
    )}
  </List>
);
```

## 测试策略

### 1. 单元测试
```typescript
// 使用 Vitest 进行单元测试
import { render, screen } from '@testing-library/react';
import { VotingPage } from './VotingPage';

describe('VotingPage', () => {
  it('renders voting proposals', () => {
    render(<VotingPage />);
    expect(screen.getByText('Voting Proposals')).toBeInTheDocument();
  });
});
```

### 2. 集成测试
```typescript
// API 集成测试
import { renderHook, waitFor } from '@testing-library/react';
import { useVotingData } from './hooks/useVotingData';

test('fetches voting data', async () => {
  const { result } = renderHook(() => useVotingData());
  
  await waitFor(() => {
    expect(result.current.isSuccess).toBe(true);
  });
  
  expect(result.current.data).toBeDefined();
});
```

### 3. E2E 测试
```typescript
// 使用 Playwright 进行端到端测试
import { test, expect } from '@playwright/test';

test('voting flow', async ({ page }) => {
  await page.goto('/voting');
  await page.click('[data-testid="vote-button"]');
  await expect(page.locator('[data-testid="vote-confirmation"]')).toBeVisible();
});
```

## 部署和构建

### 1. 构建配置
```typescript
// vite.config.ts
export default defineConfig({
  plugins: [react()],
  base: '/decentralized_decision_frontend/',
  build: {
    outDir: 'dist',
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          mui: ['@mui/material', '@mui/icons-material'],
          charts: ['recharts'],
        },
      },
    },
  },
});
```

### 2. 环境配置
```typescript
// 环境变量配置
interface ImportMetaEnv {
  readonly VITE_API_BASE_URL: string;
  readonly VITE_APP_NAME: string;
  readonly VITE_APP_VERSION: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

### 3. 部署脚本
```bash
#!/bin/bash
# deploy-gh-pages.sh

# 构建项目
npm run build

# 创建 SPA 404 重定向
cat > dist/404.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <script>
    // 重定向到 HashRouter
    window.location.replace('/decentralized_decision_frontend/#/');
  </script>
</head>
<body>Redirecting...</body>
</html>
EOF

# 推送到 gh-pages 分支
git subtree push --prefix dist origin gh-pages
```

## 监控和分析

### 1. 错误监控
```typescript
// 错误边界组件
class ErrorBoundary extends React.Component {
  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    // 发送错误到监控服务
    console.error('Error caught by boundary:', error, errorInfo);
  }
}
```

### 2. 性能监控
```typescript
// 性能指标收集
const reportWebVitals = (onPerfEntry?: (metric: any) => void) => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
};
```

## 安全考虑

### 1. 输入验证
```typescript
// 表单验证
const validateVote = (data: VoteData) => {
  const errors: Record<string, string> = {};
  
  if (!data.proposalId) {
    errors.proposalId = 'Proposal ID is required';
  }
  
  if (!data.option || !['yes', 'no', 'abstain'].includes(data.option)) {
    errors.option = 'Valid vote option is required';
  }
  
  return errors;
};
```

### 2. XSS 防护
```typescript
// 内容安全策略
const cspHeader = `
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
`;
```

### 3. CSRF 防护
```typescript
// CSRF Token 处理
const getCSRFToken = () => {
  return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
};
```

## 未来规划

### 1. 技术升级
- **React 19**: 支持并发特性和 Suspense
- **Vite 5**: 更快的构建和热更新
- **TypeScript 5**: 更好的类型推断和性能

### 2. 功能扩展
- **PWA 支持**: 离线功能和推送通知
- **Web3 集成**: 更深入的区块链交互
- **AI 辅助**: 智能推荐和决策支持

### 3. 性能优化
- **微前端**: 模块化架构
- **边缘计算**: CDN 和边缘部署
- **预渲染**: 静态生成和增量更新

---

*文档版本: 1.0.0*  
*最后更新: 2024年12月*  
*维护者: Luckee DAO 开发团队*
